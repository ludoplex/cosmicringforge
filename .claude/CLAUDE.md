# BDE with Models - LLM Context

## üîí IMMUTABLE: Directory Structure

```
bde-with-models/
‚îú‚îÄ‚îÄ vendors/libs/           # Vendored single-file libs (yyjson, sqlite3)
‚îú‚îÄ‚îÄ vendors/submodules/     # Git submodules (e9studio, cosmo-sokol, etc.)
‚îú‚îÄ‚îÄ tools/                  # Ring 0 generators (Pure C)
‚îú‚îÄ‚îÄ specs/{layer}/          # Human-authored specifications
‚îú‚îÄ‚îÄ gen/{layer}/            # Generated code (committed)
‚îú‚îÄ‚îÄ model/                  # Ring 2 external tool sources
‚îú‚îÄ‚îÄ src/                    # Application source code
‚îî‚îÄ‚îÄ scripts/                # Automation scripts
```

**DO NOT create:** `vendor/`, `upstream/`, `third-party/`, `external/`, `deps/`

---

## üö® MANDATORY: Read Before Coding

| Priority | Repository | What to Read |
|----------|------------|--------------|
| **1** | [jart/cosmopolitan](https://github.com/jart/cosmopolitan) | README, tool/cosmocc/ |
| **2** | [VENDORS.md](../VENDORS.md) | All vendor integrations |

**If you skip this**, you WILL make mistakes like:
- Using TinyCC (incompatible - relocation errors)
- Missing cosmocc flags (-mclang for 3x faster C++)

---

## Overview

**Behavior Driven Engineering with Models** ‚Äî All paths lead to C.
All tools compile with cosmocc to APE (Actually Portable Executable).

## Ring Classification

| Ring | Bootstrap | Tools | Directory |
|------|-----------|-------|-----------|
| **0** | C + sh + make | schemagen, lexgen, defgen, smgen, uigen, bddgen, Lemon | `tools/` |
| **1** | Ring 0 + C tools | makeheaders, gengetopt, cppcheck, sanitizers | `tools/ring1/` |
| **2** | External toolchains | StateSmith, Rhapsody, protobuf-c, OpenModelica | `model/` ‚Üí `gen/imported/` |

**The Rule:** Ring 2 outputs committed, builds succeed with Ring 0 only.

## ‚ö†Ô∏è Tool Compatibility

| Tool | Status | Notes |
|------|--------|-------|
| **TinyCC** | ‚ùå BANNED | "Invalid relocation entry" with cosmopolitan.a |
| **cosmocc** | ‚úÖ OK | Bundles Clang 19 + GCC 14.1.0 |
| **libclang** | ‚ö†Ô∏è Avoid | Relocation issues |

## Format ‚Üí Output Mapping (Ring 0)

| Source | Generator | Output |
|--------|-----------|--------|
| `.schema` | schemagen | `{name}_types.c,h`, `{name}_json.c,h`, `{name}_sql.c,h` |
| `.def` | defgen | `{name}_defs.h` (X-macros) |
| `.sm` | smgen | `{name}_sm.c,h` |
| `.hsm` | hsmgen | `{name}_hsm.c,h` |
| `.msm` | msmgen | `{name}_msm.c,h` |
| `.lex` | lexgen | `{name}_lex.c,h` |
| `.grammar` | Lemon | `{name}_parse.c,h` |
| `.ui` | uigen | `{name}_ui.c` (Nuklear) |
| `.feature` | bddgen | `{name}_bdd.c,h` |
| `.api` | apigen | `{name}_api.c,h` |
| `.rules` | clipsgen | `{name}_rules.c,h` |
| `.sql` | sqlgen | `{name}_db.c,h` |
| `.sig` | siggen | `{name}_ffi.h` |
| `.impl` | implgen | `{name}_impl.h` |

All Ring 0 generators are self-hosted (`*_self.h` + `*_tokens.def`).

## Commands

```bash
make formats    # Show discovered formats
make regen      # Regenerate all
make verify     # Regen + drift check
make            # Build
make run        # Execute
```

## Live Reload (e9studio)

```bash
# Terminal 1: Run target
./build/app

# Terminal 2: Attach live reload
sudo ./vendors/submodules/e9studio/test/livereload/livereload $(pgrep app) src/main.c

# Terminal 3: Edit and save - changes appear instantly!
```

## Universal Workflow

```
Edit spec ‚Üí make regen ‚Üí make verify ‚Üí make ‚Üí commit
```

## Key Files

| Purpose | Path |
|---------|------|
| Vendor Repos | `VENDORS.md` |
| Format Matrix | `INTEROP_MATRIX.md` |
| Spec Types | `SPEC_TYPES.md` |
| Conventions | `LITERATE.md` |

## Naming Convention

- Files: `{name}_{role}.c` (role: `_types`, `_sm`, `_bdd`, etc.)
- Functions: `{Type}_{action}()` (init, validate, step)
- Generators: `{name}gen.c`

## Generated File Header

```c
/* AUTO-GENERATED by {generator} {version} ‚Äî DO NOT EDIT
 * @source {spec_file}:{lines}
 * @generated {timestamp}
 * Regenerate: make regen
 */
```

## When Working on This Repo

1. Check `make formats` to see what exists
2. Edit specs in `specs/{layer}/`
3. Run `make regen` then `make verify`
4. All generated code in `gen/` is committed (drift-gated)
