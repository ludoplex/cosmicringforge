# ══════════════════════════════════════════════════════════════════════════════
# ci.yml - Main CI workflow
# ══════════════════════════════════════════════════════════════════════════════
#
# Uses shared composite action for cosmocc setup to eliminate duplication.
# See: .github/actions/setup-cosmocc/
#
# ══════════════════════════════════════════════════════════════════════════════

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ── APE Build (cosmocc) ─────────────────────────────────────────────────────
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        # Don't use recursive submodules - some are private
        # Public submodules checked out below if needed

      - name: Setup cosmocc
        uses: ./.github/actions/setup-cosmocc

      - name: Build Ring 0 tools
        run: |
          export CC=cosmocc
          make tools

      - name: Verify no drift
        run: make verify

      - name: Build application
        run: |
          export CC=cosmocc
          make app

      - name: Build e9studio (optional)
        continue-on-error: true
        run: |
          # e9studio requires private submodule - skip if unavailable
          if [ -d vendors/submodules/e9studio/.git ]; then
            export CC=cosmocc
            make e9studio
          else
            echo "Skipping e9studio (private submodule not available)"
          fi

      - name: Run smoke test
        run: make run

      - name: Verify APE binary
        run: |
          file build/app | grep -iE "DOS|MBR|boot"
          # livereload may not exist if e9studio was skipped
          if [ -f build/livereload ]; then
            file build/livereload | grep -iE "DOS|MBR|boot" || echo "Native binary"
          fi

  # ── Native Build (fallback) ─────────────────────────────────────────────────
  native:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        # Don't use recursive submodules - some are private

      - name: Build with system cc
        run: make tools app

      - name: Build e9studio (optional)
        continue-on-error: true
        run: |
          if [ -d vendors/submodules/e9studio/.git ]; then
            make e9studio
          else
            echo "Skipping e9studio (private submodule not available)"
          fi

      - name: Run tests
        run: |
          if [ -x scripts/test.sh ]; then
            ./scripts/test.sh
          else
            echo "No test script, running smoke test"
            make run
          fi
