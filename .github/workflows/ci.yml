# ══════════════════════════════════════════════════════════════════════════════
# ci.yml - Main CI workflow
# ══════════════════════════════════════════════════════════════════════════════
#
# Uses shared composite action for cosmocc setup to eliminate duplication.
# See: .github/actions/setup-cosmocc/
#
# ══════════════════════════════════════════════════════════════════════════════

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ── APE Build (cosmocc) ─────────────────────────────────────────────────────
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup cosmocc
        uses: ./.github/actions/setup-cosmocc

      - name: Build Ring 0 tools
        run: |
          export CC=cosmocc
          make tools

      - name: Verify no drift
        run: make verify

      - name: Build application
        run: |
          export CC=cosmocc
          make app

      - name: Build e9studio
        run: |
          export CC=cosmocc
          make e9studio

      - name: Run smoke test
        run: make run

      - name: Verify APE binary
        run: |
          file build/app | grep -iE "DOS|MBR|boot"
          file build/livereload | grep -iE "DOS|MBR|boot" || echo "Native binary"

  # ── Native Build (fallback) ─────────────────────────────────────────────────
  native:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build with system cc
        run: make tools app e9studio

      - name: Run tests
        run: |
          if [ -x scripts/test.sh ]; then
            ./scripts/test.sh
          else
            echo "No test script, running smoke test"
            make run
          fi
