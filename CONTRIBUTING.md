# Contributing to CosmicRingForge

## Two Protocols

There are TWO distinct protocols depending on what you're doing:

| You Are... | Protocol | CI | Tests | Docs |
|------------|----------|-----|-------|------|
| **Developing CosmicRingForge** | Repo Protocol | `repo-ci.yml` | `.forge/meta-test.sh` | This file |
| **Using the template** | Template Protocol | `template-ci.yml` | `scripts/test.sh` | `README.md` |

---

## Repo Protocol (Developing CosmicRingForge)

### Setup

```bash
git clone https://github.com/ludoplex/cosmicringforge.git
cd cosmicringforge
chmod +x .forge/*.sh scripts/*.sh
./.forge/meta-test.sh  # Verify everything works
```

### Directory Structure (Repo Development)

```
cosmicringforge/
├── .forge/                    # Meta tools (THIS repo only)
│   ├── meta-test.sh           # Test generators
│   ├── meta-audit.sh          # Audit format coverage
│   └── README.md              # Meta documentation
├── .github/workflows/
│   ├── repo-ci.yml            # CI for THIS repo
│   └── template-ci.yml        # CI for template USERS
├── tools/                     # Ring 0 generators (what we're building)
│   ├── schemagen.c            # Schema → C types
│   ├── lemon.c                # Grammar → C parser
│   └── lempar.c               # Lemon template
├── specs/                     # Example specs (shipped with template)
├── gen/                       # Example generated (shipped with template)
├── scripts/                   # User-facing scripts (shipped with template)
└── src/                       # Example app (shipped with template)
```

### Workflow (Repo Development)

```bash
# 1. Make changes to generators
nano tools/schemagen.c

# 2. Run meta-tests
./.forge/meta-test.sh

# 3. Test the example
make clean && make && make run

# 4. Verify template init works
./scripts/template-init.sh

# 5. Commit
git add -A
git commit -m "Improve schemagen: add --json flag"
```

### Adding a New Generator

1. Create `tools/{name}gen.c`
2. Add build rule to `Makefile`
3. Add processing to `scripts/regen-all.sh`
4. Update `INTEROP_MATRIX.md`
5. Add tests to `.forge/meta-test.sh`
6. Create example spec in `specs/`

### Adding a New Format

1. Document in `INTEROP_MATRIX.md`
2. Document in `SPEC_TYPES.md`
3. Create generator (or document Ring 2 tool)
4. Add to format discovery in `Makefile`
5. Add processing to `scripts/regen-all.sh`
6. Create example in `specs/`

### CI Checks (Repo)

The `repo-ci.yml` workflow checks:
- Generators compile
- Generated code compiles
- No drift in `gen/`
- Meta-tests pass
- APE build works
- Documentation is complete

---

## Template Protocol (Using CosmicRingForge)

This is what template USERS do. Documented here for reference.

### Setup (Template User)

```bash
# Use GitHub template or clone
gh repo create my-project --template ludoplex/cosmicringforge
cd my-project
./scripts/template-init.sh my-project
```

### Workflow (Template User)

```bash
# BDE Workflow
./scripts/bde-workflow.sh new domain sensor
./scripts/bde-workflow.sh regen
./scripts/bde-workflow.sh verify
./scripts/bde-workflow.sh build ape
```

### CI Checks (Template)

The `template-ci.yml` workflow checks:
- Build succeeds
- No drift in `gen/`
- Tests pass
- Application runs

---

## Ground Truth

The single source of truth is the **format interoperability matrix**:

1. **Authoritative**: `INTEROP_MATRIX.md`
2. **Encoded in**: Directory structure + Makefile pattern rules
3. **Verified by**: `.forge/meta-audit.sh`

All other documentation derives from this.

---

## Code Style

### C Code (Generators)

```c
/* ═══════════════════════════════════════════════════════════════════════
 * filename.c — Brief description
 * ═══════════════════════════════════════════════════════════════════════
 */

/* ── Section Header ──────────────────────────────────────────────────── */

/* Function names: lowercase_with_underscores */
/* Type names: PascalCase */
/* Constants: SCREAMING_SNAKE_CASE */
```

### Shell Scripts

```bash
#!/bin/sh
# POSIX sh for portability (no bashisms)
set -e

# Use functions for organization
cmd_name() {
    # ...
}

# Main dispatch at bottom
case "${1:-}" in
    name) cmd_name "$@" ;;
    *)    cmd_help ;;
esac
```

### Generated Code Headers

```c
/* AUTO-GENERATED by {generator} {version} — DO NOT EDIT
 * @source {spec_file}:{lines}
 * @generated {timestamp}
 * Regenerate: make regen
 */
```

---

## Testing

### Meta-Tests (Repo Development)

```bash
./.forge/meta-test.sh          # Full test suite
./.forge/meta-test.sh --verbose # With details
./.forge/meta-audit.sh          # Format coverage audit
```

### Template Tests

```bash
./scripts/test.sh              # BDD + compile tests
make test                      # BDD tests only
```

---

## Release Process

```bash
# 1. Update version in tools
# 2. Run full test suite
./.forge/meta-test.sh

# 3. Update CHANGELOG.md
# 4. Tag release
git tag -a v1.0.0 -m "Release 1.0.0"
git push origin v1.0.0
```

---

## Questions?

- Issues: https://github.com/ludoplex/cosmicringforge/issues
- Discussions: https://github.com/ludoplex/cosmicringforge/discussions
