# MBSE Stacks Tooling Reference

> Master inventory of all tools, their ring classification, dogfooding roles, and orchestration

This document ensures the repository can be deployed as a **GitHub template** with all tools properly catalogued and orchestrated.

---

## Tool Inventory by Ring

### Ring 0: Bootstrap Layer (C + sh + make)

| Tool | Category | Vendor Path | Dogfood Role | Orchestration |
|------|----------|-------------|--------------|---------------|
| **schemagen** | Generator | `strict-purist/gen/schemagen.c` | Generates its own types | `make gen-schema` |
| **lexgen** | Generator | `strict-purist/gen/lexgen.c` | Generates tokenizers | `make gen-lex` |
| **bin2c** | Generator | `strict-purist/vendor/bin2c/` | Embeds binaries | `make gen-embed` |
| **smgen** | Generator | `strict-purist/gen/smgen.c` | Generates FSMs from `.sm` | `make gen-sm` |
| **SQLite** | Library | `strict-purist/vendor/sqlite/` | Schema storage | Linked directly |
| **Lemon** | Parser Gen | `strict-purist/vendor/lemon/` | Generates parsers | `make gen-parser` |
| **CivetWeb** | Library | `strict-purist/vendor/civetweb/` | HTTP server | Linked directly |
| **Nuklear** | Library | `strict-purist/vendor/nuklear/` | Immediate GUI | Linked directly |
| **yyjson** | Library | `strict-purist/vendor/yyjson/` | JSON parsing | Linked directly |
| **CLIPS** | Engine | `strict-purist/vendor/clips/` | Rules engine | Linked directly |
| **Cosmopolitan** | Toolchain | `strict-purist/vendor/cosmopolitan/` | APE builds | `make PROFILE=ape` |
| **kilo** | Editor | `strict-purist/vendor/kilo/` | Minimal editor | Standalone |
| **e9patch** | Patcher | `strict-purist/vendor/e9patch/` | Binary patching | `make e9patch` |

### Ring 1: Velocity Tools (Ring 0 + C utilities)

| Tool | Category | Source | Dogfood Role | Orchestration | Fallback |
|------|----------|--------|--------------|---------------|----------|
| **gengetopt** | Generator | System | CLI parsers | `make gen-cli` | Hand-written |
| **makeheaders** | Generator | System | Auto-headers | `make gen-headers` | Manual headers |
| **AddressSanitizer** | Debug | Compiler | Memory checks | `make sanitize` | Valgrind |
| **UBSan** | Debug | Compiler | UB detection | `make sanitize` | Manual review |
| **cppcheck** | Analyzer | System | Static analysis | `make lint` | Manual review |
| **cosmo-disasm** | Disasm | `vendors/cosmo-disasm/` | Debug | `make disasm` | objdump |
| **cosmo-gcc-plugin** | Compiler | `vendors/cosmo-gcc-plugin/` | APE optimize | Optional | None |

### Ring 2: Authoring Appliances (External toolchains)

| Tool | Category | Vendor Path | Toolchain | Dogfood Role | Orchestration |
|------|----------|-------------|-----------|--------------|---------------|
| **StateSmith** | SM Gen | `foss-visual/vendor/StateSmith/` | .NET/C# | FSM → C | `make gen-statesmith` |
| **protobuf-c** | Schema Gen | `foss-visual/vendor/protobuf-c/` | C++ | Proto → C | `make gen-proto` |
| **EEZ Studio** | UI Editor | `foss-visual/vendor/eez-studio/` | Node.js | UI → C | `make gen-eez` |
| **LVGL** | UI Lib | `foss-visual/vendor/lvgl/` | C | GUI runtime | Linked directly |
| **OpenModelica** | Simulator | `foss-visual/vendor/openmodelica/` | C++/OCaml | Model → C | `make gen-modelica` |
| **Binaryen** | WASM Opt | `vendors/ludoplex-binaryen/` | C++ | WASM optimize | `make gen-wasm` |
| **WAMR** | WASM RT | `vendors/e9studio/.../wamr/` | C | WASM execute | Linked directly |

### Outside Rings: Upstream Components

| Component | Category | Path | Purpose | Orchestration |
|-----------|----------|------|---------|---------------|
| **e9studio** | IDE | `vendors/e9studio/` | Binary patching IDE | `make e9studio` |
| **cosmo-sokol** | Graphics | `vendors/cosmo-sokol/` | Cross-platform graphics | Linked |
| **cosmo-bsd** | BSD libs | `vendors/cosmo-bsd/` | BSD utilities | Linked |
| **cosmogfx** | Graphics | `vendors/cosmogfx/` | GPU abstraction | Linked |
| **tedit-cosmo** | Editor | `vendors/tedit-cosmo/` | Text editor | Standalone |
| **cosmo-include** | Headers | `vendors/cosmo-include/` | Cosmo headers | Include path |
| **cosmo-cross-sdk** | SDK | `vendors/cosmo-cross-sdk/` | Cross-compile | `make cross` |
| **awesome-cosmo** | Reference | `vendors/awesome-cosmo/` | Curated list | Documentation |
| **ludoplex-cosmo-bsd** | BSD | `vendors/ludoplex-cosmo-bsd/` | BSD ports | Optional |

---

## Dogfooding Matrix

Every tool must either **generate code** or **be generated by code**:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         DOGFOODING FLOW                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Specs (.schema, .sm, .proto, .ui)                                     │
│       │                                                                 │
│       ▼                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │
│  │  schemagen  │  │   smgen     │  │ protobuf-c  │  │ StateSmith  │   │
│  │  (Ring 0)   │  │  (Ring 0)   │  │  (Ring 2)   │  │  (Ring 2)   │   │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘   │
│         │                │                │                │           │
│         ▼                ▼                ▼                ▼           │
│      gen/*.h          gen/*.h          gen/*.h          gen/*.h       │
│      gen/*.c          gen/*.c          gen/*.c          gen/*.c       │
│         │                │                │                │           │
│         └────────────────┴────────────────┴────────────────┘           │
│                                   │                                     │
│                                   ▼                                     │
│                        src/*.c (hand-written glue)                     │
│                                   │                                     │
│                                   ▼                                     │
│                        make PROFILE={portable|ape}                     │
│                                   │                                     │
│                                   ▼                                     │
│                        build/{binary}.{exe|com}                        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Self-Hosting Requirements

| Generator | Must Generate | Generated From |
|-----------|---------------|----------------|
| schemagen | `schemagen_types.h` | `schemagen.schema` |
| smgen | `smgen_fsm.h` | `smgen.sm` |
| lexgen | `lexgen_tokens.h` | `lexgen.lex` |
| e9patch | `e9ape_types.h`, `e9ape_fsm.h` | `e9ape.schema`, `e9ape.sm` |

---

## Orchestration Scripts

### Master Makefile Targets

```makefile
# ── Ring 0 Generators ─────────────────────────────────────────────────
gen-schema:     schemagen specs/*.schema → gen/
gen-sm:         smgen specs/*.sm → gen/
gen-lex:        lexgen specs/*.lex → gen/
gen-parser:     lemon specs/*.y → gen/
gen-embed:      bin2c assets/* → gen/

# ── Ring 1 Utilities ──────────────────────────────────────────────────
gen-cli:        gengetopt specs/*.ggo → gen/
gen-headers:    makeheaders src/*.c → gen/
lint:           cppcheck src/
sanitize:       make CC="cc -fsanitize=address,undefined"

# ── Ring 2 Authoring ──────────────────────────────────────────────────
gen-statesmith: dotnet StateSmith.Cli run specs/*.drawio → gen/
gen-proto:      protoc --c_out=gen/ specs/*.proto
gen-eez:        eez-studio-build specs/*.eez-project → gen/
gen-modelica:   omc specs/*.mo → gen/
gen-wasm:       binaryen-opt specs/*.wasm → gen/

# ── Meta Targets ──────────────────────────────────────────────────────
regen:          gen-schema gen-sm gen-lex gen-parser gen-cli gen-statesmith gen-proto
verify:         git diff --exit-code gen/
template-init:  scripts/template-init.sh
```

### scripts/template-init.sh

```bash
#!/bin/sh
# Initialize cosmo-bde as a new project from template
# Usage: ./scripts/template-init.sh <project-name>

set -e

PROJECT="$1"
if [ -z "$PROJECT" ]; then
    echo "Usage: $0 <project-name>"
    exit 1
fi

echo "=== Initializing $PROJECT from cosmo-bde template ==="

# 1. Verify Ring 0 tools build
echo "--- Building Ring 0 generators ---"
make -C strict-purist/gen all

# 2. Bootstrap schemagen with itself
echo "--- Self-hosting schemagen ---"
make gen-schema SPEC=strict-purist/gen/schemagen.schema

# 3. Verify all vendor libraries compile
echo "--- Verifying vendor libraries ---"
for lib in sqlite lemon nuklear yyjson clips civetweb; do
    make -C strict-purist/vendor/$lib test || echo "WARN: $lib test skipped"
done

# 4. Run regen-and-diff gate
echo "--- Regen-and-diff gate ---"
make regen
git diff --exit-code gen/ || {
    echo "ERROR: Generated files changed. Commit gen/ first."
    exit 1
}

# 5. Initialize project-specific files
echo "--- Creating project skeleton ---"
mkdir -p $PROJECT/{src,specs,gen,build}
cp -r templates/project/* $PROJECT/

echo "=== $PROJECT initialized successfully ==="
echo "Next: cd $PROJECT && make"
```

---

## GitHub Template Configuration

### .github/template-repo.yml

```yaml
# Template repository configuration
template:
  name: cosmo-bde
  description: Model-Based Systems Engineering code generation framework

  # Files to update on template instantiation
  update_files:
    - path: README.md
      replacements:
        - find: "cosmo-bde"
          replace: "{{PROJECT_NAME}}"
    - path: Makefile
      replacements:
        - find: "PROJECT ?= cosmo-bde"
          replace: "PROJECT ?= {{PROJECT_NAME}}"

  # Directories to preserve
  preserve:
    - strict-purist/vendor/
    - foss-visual/vendor/
    - vendors/

  # Directories to clear
  clear:
    - build/
    - gen/  # User will regenerate

  # Post-init script
  post_init: scripts/template-init.sh {{PROJECT_NAME}}
```

### Required Files Checklist

For GitHub template deployment:

```
cosmo-bde/
├── .github/
│   ├── template-repo.yml          # Template config
│   └── workflows/
│       └── regen-gate.yml         # CI: regen-and-diff
├── scripts/
│   ├── template-init.sh           # Initialization script
│   ├── regen-all.sh               # Regenerate everything
│   └── verify-tools.sh            # Verify toolchain
├── templates/
│   └── project/                   # Skeleton for new projects
│       ├── Makefile
│       ├── specs/
│       │   └── example.schema
│       └── src/
│           └── main.c
├── TOOLING.md                     # This file
├── RING_CLASSIFICATION.md         # Ring definitions
├── LICENSES.md                    # License tracking
├── AGENTS.md                      # Universal LLM context
├── CONVENTIONS.md                 # Code conventions
└── Makefile                       # Master build
```

---

## Tool Verification Matrix

Before releasing as template, verify:

| Category | Check | Command |
|----------|-------|---------|
| Ring 0 | schemagen self-hosts | `make gen-schema SPEC=schemagen.schema` |
| Ring 0 | SQLite compiles | `make -C vendor/sqlite test` |
| Ring 0 | Lemon compiles | `make -C vendor/lemon test` |
| Ring 0 | APE builds work | `make PROFILE=ape test` |
| Ring 1 | Lint passes | `make lint` |
| Ring 1 | Sanitizers clean | `make sanitize test` |
| Ring 2 | StateSmith generates | `make gen-statesmith` |
| Ring 2 | protobuf-c generates | `make gen-proto` |
| Meta | Regen-and-diff clean | `make regen verify` |

---

## Adding New Tools

### Ring 0 (must be C + sh + make only)

```bash
# 1. Add to vendor
mkdir -p strict-purist/vendor/newtool
cp /path/to/newtool.c strict-purist/vendor/newtool/

# 2. Create Makefile
cat > strict-purist/vendor/newtool/Makefile << 'EOF'
CC ?= cc
CFLAGS ?= -O2 -Wall

all: newtool
newtool: newtool.c
	$(CC) $(CFLAGS) -o $@ $<
clean:
	rm -f newtool
EOF

# 3. Document
echo "| newtool | Purpose | vendor/newtool/ | Role | Target |" >> TOOLING.md

# 4. Add to orchestration
echo "newtool: strict-purist/vendor/newtool/newtool" >> Makefile
```

### Ring 2 (outputs must be committed)

```bash
# 1. Add to vendor
git submodule add https://github.com/example/tool foss-visual/vendor/tool

# 2. Create generation script
cat > scripts/gen-tool.sh << 'EOF'
#!/bin/sh
tool generate specs/*.spec -o gen/tool/
echo "$(tool --version)" > gen/tool/GENERATOR_VERSION
sha256sum gen/tool/* > gen/tool/SHA256SUMS
EOF

# 3. Commit generated outputs
make gen-tool
git add gen/tool/
git commit -m "Add tool-generated outputs"
```

---

## Quick Reference Card

```
┌────────────────────────────────────────────────────────────────────────┐
│                    MBSE STACKS QUICK REFERENCE                         │
├────────────────────────────────────────────────────────────────────────┤
│ Bootstrap:     make PROFILE=portable           (system cc)            │
│ APE Build:     make PROFILE=ape                (cosmocc → .com)       │
│ Regenerate:    make regen                      (all generators)       │
│ Verify:        make regen && git diff --exit-code gen/                │
│ Template:      ./scripts/template-init.sh myproject                   │
├────────────────────────────────────────────────────────────────────────┤
│ Specs:         *.schema (types), *.sm (FSM), *.proto, *.y (grammar)  │
│ Generated:     gen/{tool}/{output}.{h,c}                              │
│ Hand-written:  src/*.{h,c}                                            │
│ Output:        build/{binary}.{exe,com}                               │
├────────────────────────────────────────────────────────────────────────┤
│ Ring 0: C+sh+make only → schemagen, smgen, lexgen, lemon, sqlite     │
│ Ring 1: Ring 0 + utils → gengetopt, cppcheck, sanitizers             │
│ Ring 2: External tools → StateSmith, protobuf-c, EEZ, Binaryen       │
└────────────────────────────────────────────────────────────────────────┘
```
